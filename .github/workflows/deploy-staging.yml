name: Deploy Node.js to Staging

on:
  workflow_run:
    workflows: ["Build & Release"]
    types: [completed]
    branches: [develop]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag de la versi√≥n (ej. v1.0.0-develop)"
        required: true

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  ENVIRONMENT: staging
  HEALTH_CHECK_TIMEOUT: 30
  RELEASE_TAG: ${{ github.event.release.tag_name }}
  NODE_VERSION: "20"

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted
    environment: staging
    env:
      APP_PATH: ${{ secrets.STAGING_PATH }}
    steps:
      - name: Setup Node.js ${{ env.NODE_VERSION }} 4
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Get Latest Release
        id: last_release
        run: |
            # Usamos la API de GitHub para saber cu√°l es el √∫ltimo tag
            TAG=$(curl -s https://api.github.com/repos/RMP11/publicaciones.backend/releases/latest | jq -r .tag_name)
            echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Deploy Local
        env:
          RELEASE_TAG: ${{ steps.last_release.outputs.tag }}
        run: |
          echo "La ruta es: $APP_PATH" # Aqu√≠ debe imprimir el valor

          # 1. Definir rutas (Usa rutas absolutas para evitar el error ***)

          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_DIR="${APP_PATH}/releases/${TIMESTAMP}"
          ARTIFACT_NAME="sistema-ventas-${RELEASE_TAG}"
          DOWNLOAD_URL="https://github.com/RMP11/publicaciones.backend/releases/download/${RELEASE_TAG}/${ARTIFACT_NAME}.tar.gz"
          
          echo "üì¶ Descargando release: ${RELEASE_TAG}"
          mkdir -p "/tmp/deploy-${TIMESTAMP}"
          curl -fsSL -o "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" "$DOWNLOAD_URL"
          
          echo "üìÇ Extrayendo en ${RELEASE_DIR}"
          mkdir -p "${RELEASE_DIR}"
          tar -xzf "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" -C "${RELEASE_DIR}"
          
          echo "üîó Enlazando configuraci√≥n y uploads"
          ln -sfn "${APP_PATH}/shared/.env" "${RELEASE_DIR}/.env"
          if [ -d "${APP_PATH}/shared/uploads" ]; then
            ln -sfn "${APP_PATH}/shared/uploads" "${RELEASE_DIR}/uploads"
          fi
          
          echo "‚öôÔ∏è Instalando dependencias"
          cd "${RELEASE_DIR}"
          npm ci --production
          
          echo "‚ö° Cambio at√≥mico de versi√≥n"
          ln -sfn "${RELEASE_DIR}" "${APP_PATH}/current.new"
          mv -Tf "${APP_PATH}/current.new" "${APP_PATH}/current"
          
          echo "üîÉ Reiniciando con PM2"
          # Usamos la ruta absoluta para evitar el error 'command not found'
          # Si 'which pm2' te da otra ruta, c√°mbiala aqu√≠:
          PM2_PATH=$(which pm2 || echo "/usr/local/bin/pm2")
          
          cd "${APP_PATH}/current"
          $PM2_PATH reload ecosystem.config.js --env staging || $PM2_PATH start dist/index.js --name "sistema-ventas"
          
          echo "üßπ Limpieza"
          rm -rf "/tmp/deploy-${TIMESTAMP}"
          cd "${APP_PATH}/releases"
          ls -t | tail -n +4 | xargs -r rm -rf
          
          echo "‚úÖ Despliegue completado"

      - name: Health Check
        run: |
          echo "üè• Verificando estado del servicio..."
          sleep 10
          HEALTH_URL="${{ secrets.STAGING_URL }}/health"
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time ${{ env.HEALTH_CHECK_TIMEOUT }} "$HEALTH_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Fall√≥ Health check con c√≥digo: $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Servicio en l√≠nea"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT }}
          script: |
            cd ${{ secrets.STAGING_PATH }}
            PREVIOUS=$(ls -t releases | sed -n '2p')
            if [ -n "$PREVIOUS" ]; then
              echo "üîô Volviendo a la versi√≥n: ${PREVIOUS}"
              ln -sfn "$(pwd)/releases/${PREVIOUS}" current.new
              mv -Tf current.new current
              pm2 reload all
            fi