name: Deploy Node.js to Staging

on:
  workflow_run:
    workflows: ["Build & Release"]
    types: [completed]
    branches: [develop]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag de la versi√≥n (ej. v1.0.0-develop)"
        required: true

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  ENVIRONMENT: staging
  HEALTH_CHECK_TIMEOUT: 30
  RELEASE_TAG: ${{ github.event.release.tag_name }}

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop')
    environment: staging
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4


      - name: Get Release Tag
        id: release
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          else
            RELEASE_TAG=$(gh release list --limit 10 | grep -E 'develop' | head -1 | awk '{print $1}' || echo "")
            if [ -z "$RELEASE_TAG" ]; then echo "No release found"; exit 1; fi
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy Application
        # uses: appleboy/ssh-action@v1.2.2
        # with:
        #   host: ${{ secrets.STAGING_HOST }}
        #   username: ${{ secrets.STAGING_USER }}
        #   key: ${{ secrets.STAGING_SSH_KEY }}
        #   port: ${{ secrets.STAGING_SSH_PORT }}
        #   command_timeout: 10m
        run: |
            set -e
            cd ${{ secrets.STAGING_PATH }}

            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            RELEASE_DIR="releases/${TIMESTAMP}"
            ARTIFACT_NAME="sistema-ventas-${RELEASE_TAG}"
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${ARTIFACT_NAME}.tar.gz"

            echo "üì¶ Descargando release: ${RELEASE_TAG}"
            mkdir -p "/tmp/deploy-${TIMESTAMP}"
            curl -fsSL -o "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" "$DOWNLOAD_URL"

            echo "üìÇ Extrayendo en ${RELEASE_DIR}"
            mkdir -p "${RELEASE_DIR}"
            tar -xzf "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" -C "${RELEASE_DIR}"

            echo "üîó Enlazando configuraci√≥n (.env) y uploads"
            # Node.js suele usar .env y carpetas de archivos subidos
            ln -sfn "$(pwd)/shared/.env" "${RELEASE_DIR}/.env"
            if [ -d "$(pwd)/shared/uploads" ]; then
              ln -sfn "$(pwd)/shared/uploads" "${RELEASE_DIR}/uploads"
            fi

            echo "‚öôÔ∏è Instalando dependencias de producci√≥n"
            cd "${RELEASE_DIR}"
            # npm ci es m√°s r√°pido y seguro para deploys
            npm ci --production

            # Si usas TypeScript y necesitas transpilar en el servidor (opcional):
            # npm run build 

            echo "‚ö° Cambio at√≥mico de versi√≥n"
            cd ${{ secrets.STAGING_PATH }}
            ln -sfn "$(pwd)/${RELEASE_DIR}" current.new
            mv -Tf current.new current

            echo "üîÉ Reiniciando aplicaci√≥n con PM2"
            # Usamos reload para que no haya tiempo de inactividad
            cd current
            pm2 reload ecosystem.config.js --env staging || pm2 start dist/index.js --name "mi-app-node"

            echo "üßπ Limpieza"
            rm -rf "/tmp/deploy-${TIMESTAMP}"
            cd ../releases
            ls -t | tail -n +4 | xargs -r rm -rf

            echo "‚úÖ Despliegue Node.js completado"

      - name: Health Check
        run: |
          echo "üè• Verificando estado del servicio..."
          sleep 10
          HEALTH_URL="${{ secrets.STAGING_URL }}/health"
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time ${{ env.HEALTH_CHECK_TIMEOUT }} "$HEALTH_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Fall√≥ Health check con c√≥digo: $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Servicio en l√≠nea"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT }}
          script: |
            cd ${{ secrets.STAGING_PATH }}
            PREVIOUS=$(ls -t releases | sed -n '2p')
            if [ -n "$PREVIOUS" ]; then
              echo "üîô Volviendo a la versi√≥n: ${PREVIOUS}"
              ln -sfn "$(pwd)/releases/${PREVIOUS}" current.new
              mv -Tf current.new current
              pm2 reload all
            fi