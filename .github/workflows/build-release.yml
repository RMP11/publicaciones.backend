name: Build & Release

on:
  push:
    branches:
      - main
      - develop
      - ci-dia4
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., 1.0.0)"
        required: false
        default: ""

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  NODE_VERSION: "20"

jobs:
  build:
    name: Build Application
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_name: ${{ steps.version.outputs.release_name }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Generar versi칩n autom치tica
      - name: Generate Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="1.0.0"
          fi
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME=${{ github.ref_name }}

          if [ "$BRANCH_NAME" == "main" ]; then
            RELEASE_NAME="v${VERSION}-${TIMESTAMP}"
            PRERELEASE="false"
          else
            RELEASE_NAME="v${VERSION}-${BRANCH_NAME}-${TIMESTAMP}"
            PRERELEASE="true"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE}" >> $GITHUB_OUTPUT

      # 2. Setup Node.js
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      # 3. Instalar todas las dependencias (incluyendo devDeps para el build)
      - name: Install Dependencies
        run: npm ci

      # 4. Construir la aplicaci칩n (NestJS/Vite/Next)
      - name: Build Project
        run: |
          npm run build --if-present
          echo "Build completed"

      # 5. Crear archivo de versi칩n (칰til para el Health Check)
      - name: Create Version File
        run: |
          mkdir -p dist
          echo '{
            "version": "${{ steps.version.outputs.version }}",
            "release": "${{ steps.version.outputs.release_name }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "built_at": "'$(date -Iseconds)'"
          }' > dist/version.json

      # 6. Crear el Artefacto (.tar.gz)
      # IMPORTANTE: Excluimos node_modules porque se deben instalar en el servidor 
      # con 'npm ci --production' para evitar conflictos de arquitectura binaria.
      - name: Create Release Artifact
        run: |
          ARTIFACT_NAME="sistema-ventas-${{ steps.version.outputs.release_name }}"
          
          tar -czf "${ARTIFACT_NAME}.tar.gz" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='src' \
            --exclude='tests' \
            --exclude='*.md' \
            --exclude='.env*' \
            --exclude='release.tar.gz' \
            . || [[ $? -eq 1 ]]

          sha256sum "${ARTIFACT_NAME}.tar.gz" > "${ARTIFACT_NAME}.tar.gz.sha256"
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_ENV

      # 7. Subir Artefacto a GitHub Actions
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact
          path: |
            ${{ env.artifact_name }}.tar.gz
            ${{ env.artifact_name }}.tar.gz.sha256
          retention-days: 7

      # 8. Crear la Release en GitHub
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.release_name }}
          name: "Release ${{ steps.version.outputs.release_name }}"
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: true
          files: |
            ${{ env.artifact_name }}.tar.gz
            ${{ env.artifact_name }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "## 游 Node.js Build Success" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release** | \`${{ steps.version.outputs.release_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact** | \`${{ env.artifact_name }}.tar.gz\` |" >> $GITHUB_STEP_SUMMARY